#include "InstructionMetadata.h"

#include <fstream>
#include <json/json.h>

namespace dev
{
namespace eth
{


std::map<Instruction, InstructionMetadata> parseInstructionsFromFile(const std::string& filepath)
{
    std::ifstream ifs(filepath);
    Json::Value root;
    ifs >> root;

    std::map<Instruction, InstructionMetadata> instructionsMetadata;

    auto stats = root["stats"];

    for (auto itr = stats.begin(); itr != stats.end(); itr++)
    {
        auto instruction = instructionFromName(itr.key().asString());
        if (instruction == Instruction::INVALID)
        {
            continue;
        }
        auto instructionStats = *itr;
        InstructionMetadata metadata = InstructionMetadata {
            .instruction = instruction,
            .executedCount = instructionStats["count"].asUInt64(),
            .executionTimeMean = instructionStats["mean"].asDouble(),
            .executionTimeStdev = instructionStats["stdev"].asDouble()
        };
        instructionsMetadata[instruction] = metadata;
    }

    return instructionsMetadata;
}

}
}