#include "Program.h"

#include <stdexcept>
#include <boost/algorithm/string.hpp>

namespace dev
{
namespace eth
{

ProgramData::ProgramData(std::string data)
{
    if (data.substr(0, 2) == "0x")
    {
        data = data.substr(2);
    }
    if (data.size() % 2 != 0)
    {
        throw std::runtime_error("string size should be a multiple of 2");
    }
    size = data.size() / 2;
    std::stringstream ss(data);
    ss >> std::hex >> value;
}

std::shared_ptr<ProgramInstruction> ProgramInstruction::create(Instruction instruction, ProgramData data)
{
    return std::make_shared<ProgramInstructionWithData>(instruction, data);
}

std::string ProgramData::toString() const
{
    std::stringstream ss;
    size_t stringSize = size * 2;
    ss << std::hex << std::setw(stringSize) << std::setfill('0') << value;
    auto res = ss.str();
    if (res.size() > stringSize)
    {
        res = res.substr(res.size() - stringSize, res.size());
    }
    return boost::algorithm::to_lower_copy(res);
}

std::string ProgramInstruction::toBytecode() const
{
    std::stringstream ss;
    ss << std::hex << std::setw(2) << std::setfill('0') << static_cast<int>(m_instruction);
    return boost::algorithm::to_lower_copy(ss.str());
}

std::string ProgramInstructionWithData::toBytecode() const
{
    std::stringstream ss;
    ss << ProgramInstruction::toBytecode();
    ss << m_data.toString();
    return ss.str();
}


Program::Program() {}
Program::Program(std::vector<std::shared_ptr<ProgramInstruction>> _instructions)
    : m_instructions(_instructions) {}


void Program::addInstruction(std::shared_ptr<ProgramInstruction> pInstruction)
{
    auto info = instructionInfo(pInstruction->instruction());
    if (static_cast<uint64_t>(info.args) > m_stackSize)
    {
        throw std::runtime_error("not enough words on the stack");
    }
    auto stackDifference = info.ret - info.args;
    m_stackSize += stackDifference;
    m_instructions.push_back(pInstruction);
}

std::string Program::toBytecode() const
{
    std::stringstream sstream;
    for (auto inst: m_instructions)
    {
        sstream << inst->toBytecode();
    }
    return sstream.str();
}

}
}
