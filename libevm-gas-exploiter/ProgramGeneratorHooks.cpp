#include "ProgramGeneratorHooks.h"

namespace
{
    const size_t minMemoryToUse = 1;
    const size_t maxMemoryToUse = 0xff;
    std::uniform_int_distribution<int> memoryLengthDistribution(minMemoryToUse , maxMemoryToUse);
}

namespace dev
{
namespace eth
{

const std::map<std::string, std::shared_ptr<ProgramGeneratorHook>> availableHooks = {
    {"fix-memory", std::make_shared<FixMemoryHook>()}
};


void FixMemoryHook::execute(
    Program& program, const std::shared_ptr<ProgramInstruction> inst, std::default_random_engine rand_engine)
{
    switch (inst->instruction())
    {
    /// signature: CALLDATACOPY(destOffset, offset, length)
    ///            CODECOPY(destOffset, offset, length)
    /// stack before: x, y, z
    /// stack after:  x, y, memoryToUse, z
    case Instruction::CALLDATACOPY:
    case Instruction::CODECOPY:
    {
        auto memoryLength = memoryLengthDistribution(rand_engine);
        program.addInstruction(Instruction::PUSH1, ProgramData(memoryLength, 1));
        program.addInstruction(Instruction::DUP3);
        program.addInstruction(Instruction::POP);
        break;
    }
    /// signature: MSTORE(offset, value)
    ///            MSTORE8(offset, value)
    /// stack before: x, y
    /// stack after:  offset, x, y
    case Instruction::MSTORE8:
    case Instruction::MSTORE:
    {
        auto offset = memoryLengthDistribution(rand_engine);
        program.addInstruction(Instruction::PUSH1, ProgramData(offset, 1));
        break;
    }

    default:
        break;
    }
}

}
}